name: Terraform Environments

on:
  workflow_call:
    inputs:
      role-to-assume:
        required: true
        type: string
      aws-region:
        required: true
        type: string
      working-directory:
        required: false
        type: string
        default: "."
    secrets:
      TF_GITHUB_PAT:
        required: true
      TF_VAR_OIDC_CLIENT_SECRET:
        required: false

jobs:
  terraform-dev:
    name: Terraform Dev
    runs-on: ubuntu-latest
    environment: dev

    env:
      AWS_REGION: ${{ inputs.aws-region }}
      TF_GITHUB_PAT: ${{ secrets.TF_GITHUB_PAT }}
      TF_VAR_OIDC_CLIENT_SECRET: ${{ secrets.TF_VAR_OIDC_CLIENT_SECRET }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (dev)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs['role-to-assume'] }}
          aws-region: ${{ inputs['aws-region'] }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init (dev)
        working-directory: ${{ inputs['working-directory'] }}
        run: terraform init

      - name: Terraform Plan (dev)
        working-directory: ${{ inputs['working-directory'] }}
        run: terraform plan -out=dev.tfplan

      - name: Terraform Apply (dev)
        working-directory: ${{ inputs['working-directory'] }}
        run: terraform apply -auto-approve dev.tfplan

  terraform-preprod:
    name: Terraform Preprod
    runs-on: ubuntu-latest
    needs: terraform-dev           # only runs if dev succeeded
    environment: preprod

    env:
      AWS_REGION: ${{ inputs.aws-region }}
      TF_GITHUB_PAT: ${{ secrets.TF_GITHUB_PAT }}
      TF_VAR_OIDC_CLIENT_SECRET: ${{ secrets.TF_VAR_OIDC_CLIENT_SECRET }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (preprod)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs['role-to-assume'] }}
          aws-region: ${{ inputs['aws-region'] }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init (preprod)
        working-directory: ${{ inputs['working-directory'] }}
        run: terraform init

      - name: Terraform Plan (preprod)
        working-directory: ${{ inputs['working-directory'] }}
        run: terraform plan -out=preprod.tfplan

      - name: Terraform Apply (preprod)
        working-directory: ${{ inputs['working-directory'] }}
        run: terraform apply -auto-approve preprod.tfplan

  terraform-prod-plan:
    name: Terraform Prod Plan
    runs-on: ubuntu-latest
    needs: terraform-preprod       # only runs if preprod succeeded
    environment: prod              # env for visibility; apply job gates approval

    env:
      AWS_REGION: ${{ inputs.aws-region }}
      TF_GITHUB_PAT: ${{ secrets.TF_GITHUB_PAT }}
      TF_VAR_OIDC_CLIENT_SECRET: ${{ secrets.TF_VAR_OIDC_CLIENT_SECRET }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (prod - plan)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs['role-to-assume'] }}
          aws-region: ${{ inputs['aws-region'] }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init (prod)
        working-directory: ${{ inputs['working-directory'] }}
        run: terraform init

      - name: Terraform Plan (prod)
        working-directory: ${{ inputs['working-directory'] }}
        run: terraform plan -out=prod.tfplan

      - name: Upload Prod Plan
        uses: actions/upload-artifact@v4
        with:
          name: prod-tfplan
          path: ${{ inputs['working-directory'] }}/prod.tfplan

  terraform-prod-apply:
    name: Terraform Prod Apply (Manual)
    runs-on: ubuntu-latest
    needs: terraform-prod-plan
    # This is the manual step:
    # Configure the "prod" environment in GitHub with required reviewers.
    # When this job is reached, GitHub will WAIT for manual approval.
    environment:
      name: prod

    env:
      AWS_REGION: ${{ inputs.aws-region }}
      TF_GITHUB_PAT: ${{ secrets.TF_GITHUB_PAT }}
      TF_VAR_OIDC_CLIENT_SECRET: ${{ secrets.TF_VAR_OIDC_CLIENT_SECRET }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (prod - apply)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs['role-to-assume'] }}
          aws-region: ${{ inputs['aws-region'] }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Download Prod Plan
        uses: actions/download-artifact@v4
        with:
          name: prod-tfplan
          path: ${{ inputs['working-directory'] }}

      - name: Terraform Apply (prod)
        working-directory: ${{ inputs['working-directory'] }}
        run: terraform apply prod.tfplan
